<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Burn Scar Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <style>
        :root {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }

        body { margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar for Controls */
        .sidebar {
            width: 350px;
            background: #1e293b;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        h1 { margin: 0 0 1rem; font-size: 1.25rem; color: #60a5fa; }
        .label { font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.25rem; display: block; }
        input {
            width: 100%;
            background: #334155;
            border: 1px solid #475569;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #475569; cursor: not-allowed; }

        .results { margin-top: 2rem; display: none; }
        .result-item { margin-bottom: 1.5rem; text-align: center; }
        .result-item img {
            width: 100%;
            border-radius: 0.5rem;
            border: 2px solid #334155;
        }
        .stats-box {
            background: #0f172a;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .badge-high { background: #7f1d1d; color: #fecaca; }
        .badge-mod { background: #7c2d12; color: #fed7aa; }
        .badge-low { background: #713f12; color: #fef08a; }
        
        /* Loading Overlay */
        #loader {
            display: none;
            text-align: center;
            margin: 1rem 0;
            color: #60a5fa;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>ðŸ”¥ Burn Scar Analytics</h1>
        
        <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 1.5rem;">
            Use the toolbar on the map to draw a rectangle over the area you want to analyze.
        </p>

        <div>
            <label class="label">Analysis Date Range</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="date" id="dateFrom" value="2023-08-01">
                <input type="date" id="dateTo" value="2023-08-30">
            </div>
        </div>

        <input type="hidden" id="minLon">
        <input type="hidden" id="minLat">
        <input type="hidden" id="maxLon">
        <input type="hidden" id="maxLat">

        <button id="analyzeBtn" onclick="runAnalysis()" disabled>Draw Area First</button>
        
        <div id="loader">Processing Satellite Data...<br><small>(This may take 10-20 seconds)</small></div>

        <div class="results" id="resultsArea">
            <div class="stats-box" id="statsContent"></div>
            
            <div class="result-item">
                <span class="label">Severity Analysis</span>
                <img id="severityImg" src="" alt="Severity Map">
            </div>
            <div class="result-item">
                <span class="label">Burn Mask Overlay</span>
                <img id="overlayImg" src="" alt="Overlay">
            </div>
            <div class="result-item">
                <span class="label">True Color (RGB)</span>
                <img id="rgbImg" src="" alt="RGB">
            </div>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        const API_BASE = "http://localhost:8000"; // Adjust if needed

        // Initialize Map
        const map = L.map('map').setView([33.68, 73.04], 6); // Default to Pakistan, zoom out
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Feature Group for the drawn box
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize Draw Control
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                marker: false,
                circle: false,
                circlemarker: false,
                polyline: false,
                rectangle: { shapeOptions: { color: '#ef4444' } }
            },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        // Handle Draw Events
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers(); // Only allow one box
            const layer = e.layer;
            drawnItems.addLayer(layer);
            
            const bounds = layer.getBounds();
            updateCoords(bounds);
        });

        map.on(L.Draw.Event.EDITED, function (e) {
            e.layers.eachLayer(function(layer) {
                updateCoords(layer.getBounds());
            });
        });

        function updateCoords(bounds) {
            document.getElementById('minLat').value = bounds.getSouth();
            document.getElementById('maxLat').value = bounds.getNorth();
            document.getElementById('minLon').value = bounds.getWest();
            document.getElementById('maxLon').value = bounds.getEast();
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = false;
            btn.textContent = "Run Analysis";
            btn.style.background = "#2563eb";
        }

        async function runAnalysis() {
            const btn = document.getElementById('analyzeBtn');
            const loader = document.getElementById('loader');
            const results = document.getElementById('resultsArea');
            
            btn.disabled = true;
            loader.style.display = 'block';
            results.style.display = 'none';

            const payload = {
                min_lon: parseFloat(document.getElementById('minLon').value),
                min_lat: parseFloat(document.getElementById('minLat').value),
                max_lon: parseFloat(document.getElementById('maxLon').value),
                max_lat: parseFloat(document.getElementById('maxLat').value),
                date_from: document.getElementById('dateFrom').value,
                date_to: document.getElementById('dateTo').value
            };

            try {
                const resp = await fetch(`${API_BASE}/predict_with_bbox`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) throw new Error("Analysis failed");
                const data = await resp.json();

                // Update Images
                document.getElementById('rgbImg').src = "data:image/png;base64," + data.rgb_base64;
                document.getElementById('overlayImg').src = "data:image/png;base64," + data.overlay_base64;
                document.getElementById('severityImg').src = "data:image/png;base64," + data.severity_base64;

                // Update Stats
                const statsHtml = `
                    <div class="stat-row"><span>Total Area:</span> <strong>${(data.total_pixels * 100 / 10000).toFixed(1)} ha</strong></div>
                    <div class="stat-row"><span>Burned Area:</span> <strong>${(data.burned_pixels * 100 / 10000).toFixed(1)} ha</strong></div>
                    <hr style="border-color: #334155; margin: 0.5rem 0;">
                    <div class="stat-row">
                        <span class="badge badge-high">High Severity</span>
                        <span>${(data.severity_breakdown.high * 100).toFixed(1)}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="badge badge-mod">Moderate</span>
                        <span>${(data.severity_breakdown.moderate * 100).toFixed(1)}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="badge badge-low">Low</span>
                        <span>${(data.severity_breakdown.low * 100).toFixed(1)}%</span>
                    </div>
                `;
                document.getElementById('statsContent').innerHTML = statsHtml;

                results.style.display = 'block';
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>